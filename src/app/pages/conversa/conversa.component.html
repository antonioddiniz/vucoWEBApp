<div class="conversa-container"
     [style.transform]="containerTransform"
     [class.swiping]="isSwipingBack"
     (touchstart)="onTouchStart($event)"
     (touchmove)="onTouchMove($event)"
     (touchend)="onTouchEnd($event)">
  <div class="conversa-header">
    <button mat-icon-button (click)="voltar()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <div class="header-content">
      <h2 class="chat-title">Troca #{{ chat?.transacaoId || chatId }}</h2>
      <div class="troca-info" *ngIf="chat?.transacao">
        <div class="troca-resumo">
          <span class="info-label">VocÃª oferece:</span>
          <div class="produtos-miniaturas">
            <div class="produto-miniatura" *ngFor="let produto of getProdutosUsuario()" [title]="produto.nome">
              <img [src]="produto.imagem" [alt]="produto.nome" (error)="onImageError($event)">
            </div>
            <span *ngIf="getProdutosUsuario().length === 0" class="sem-produtos">Nenhum</span>
          </div>
        </div>
        <div class="troca-resumo">
          <span class="info-label">VocÃª recebe:</span>
          <div class="produtos-miniaturas">
            <div class="produto-miniatura" *ngFor="let produto of getProdutosOutroUsuario()" [title]="produto.nome">
              <img [src]="produto.imagem" [alt]="produto.nome" (error)="onImageError($event)">
            </div>
            <span *ngIf="getProdutosOutroUsuario().length === 0" class="sem-produtos">Nenhum</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mensagens-container" #mensagensContainer>
    <div *ngIf="carregando || descriptografando" class="loading">
      <p *ngIf="carregando">Carregando mensagens...</p>
      <p *ngIf="!carregando && descriptografando">ðŸ”’ Descriptografando...</p>
    </div>

    <div *ngIf="!carregando && !descriptografando && mensagens.length === 0" class="sem-mensagens">
      <p>ðŸ‘‹ Inicie a conversa!</p>
    </div>

    <div class="mensagens-lista" *ngIf="!carregando && !descriptografando && mensagens.length > 0">
      <div 
        *ngFor="let msg of mensagens" 
        class="mensagem"
        [class.minha-mensagem]="ehMinhaMsg(msg)"
        [class.outra-mensagem]="!ehMinhaMsg(msg)">
        
        <div class="mensagem-balao">
          <p class="mensagem-texto">{{ msg.texto }}</p>
          <div class="mensagem-footer">
            <span class="mensagem-hora">{{ formatarHora(msg.dataEnvio) }}</span>
            <mat-icon *ngIf="ehMinhaMsg(msg) && msg.lida" class="check-lida">
              done_all
            </mat-icon>
            <mat-icon *ngIf="ehMinhaMsg(msg) && !msg.lida" class="check-enviada">
              done
            </mat-icon>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="input-container">
    <mat-form-field appearance="outline" class="mensagem-input">
      <input 
        matInput 
        [(ngModel)]="novoTexto"
        (keyup.enter)="enviarMensagem()"
        placeholder="Digite sua mensagem..."
        [disabled]="enviando">
    </mat-form-field>
    <button 
      mat-fab 
      color="primary" 
      (click)="enviarMensagem()"
      [disabled]="!novoTexto.trim() || enviando"
      class="btn-enviar">
      <mat-icon>send</mat-icon>
    </button>
  </div>
</div>
