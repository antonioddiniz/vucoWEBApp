<!-- transacoes.component.html -->
<div class="transacoes-container">
  <h2 class="page-title">Minhas Transações</h2>

  <!-- Abas de status -->
  <div class="tabs-wrapper">
    <div class="tabs">
      <button [class.active]="statusSelecionado === 2" (click)="selecionarStatus(2)">
        Pendentes
      </button>
      <button [class.active]="statusSelecionado === 1" (click)="selecionarStatus(1)">
        Concluídas
      </button>
      <button [class.active]="statusSelecionado === 3" (click)="selecionarStatus(3)">
        Canceladas
      </button>
    </div>
  </div>

  <div *ngIf="transacoes.length === 0" class="sem-transacoes">
    Nenhuma transação encontrada para este status.
  </div>

  <div class="transacoes-grid">
    <div *ngFor="let transacao of transacoes" class="transacao-card" (click)="abrirDetalhes(transacao)">
      <div class="produtos-multiplos">
        <!-- Meus Produtos (que estou oferecendo) -->
        <div class="produtos-lado">
          <h4 class="lado-titulo">Você oferece:</h4>
          <div class="produtos-lista">
            <div *ngFor="let produto of getMeusProdutos(transacao)" class="produto-mini">
              <img 
                [src]="produto.imagem" 
                [alt]="produto.nome"
                (error)="onImageError($event)"
              />
              <p class="produto-nome-mini">{{ produto.nome }}</p>
            </div>
            <p *ngIf="getMeusProdutos(transacao).length === 0" class="sem-produtos">Nenhum produto</p>
          </div>
          <span class="count-badge">{{ getMeusProdutos(transacao).length }} item(ns)</span>
        </div>

        <div class="troca-icon-grande">⇄</div>

        <!-- Produtos do outro usuário (que vou receber) -->
        <div class="produtos-lado">
          <h4 class="lado-titulo">Você recebe:</h4>
          <div class="produtos-lista">
            <div *ngFor="let produto of getProdutosOutroUsuario(transacao)" class="produto-mini">
              <img 
                [src]="produto.imagem" 
                [alt]="produto.nome"
                (error)="onImageError($event)"
              />
              <p class="produto-nome-mini">{{ produto.nome }}</p>
            </div>
            <p *ngIf="getProdutosOutroUsuario(transacao).length === 0" class="sem-produtos">Nenhum produto</p>
          </div>
          <span class="count-badge">{{ getProdutosOutroUsuario(transacao).length }} item(ns)</span>
        </div>
      </div>

      <div class="transacao-info">
        <p class="info-item">
          <strong>Data:</strong> 
          <span>{{ transacao.dataTransacao | date:'dd/MM/yyyy HH:mm' }}</span>
        </p>
        <p class="info-item">
          <strong>Status:</strong> 
          <span [ngSwitch]="transacao.status" class="status-badge">
            <span *ngSwitchCase="1" class="status-concluida">Concluída</span>
            <span *ngSwitchCase="2" class="status-pendente">Pendente</span>
            <span *ngSwitchCase="3" class="status-cancelada">Cancelada</span>
            <span *ngSwitchCase="4" class="status-estornada">Estornada</span>
            <span *ngSwitchDefault>Desconhecido</span>
          </span>
        </p>
      </div>

      <div class="botoes-transacao" *ngIf="statusSelecionado === 2">
        <!-- Se o usuário logado foi quem enviou a transação, mostra apenas o botão de cancelar -->
        <ng-container *ngIf="isUsuarioEnviou(transacao); else botoesRecebedor">
          <button class="btn-recusar" (click)="$event.stopPropagation(); abrirDeletar(transacao)">
            Cancelar
          </button>
        </ng-container>
        <!-- Se o usuário logado recebeu a transação, mostra todos os botões -->
        <ng-template #botoesRecebedor>
          <button class="btn-aceitar" (click)="$event.stopPropagation(); abrirConfirmacao(transacao)">
            Aceitar
          </button>
          <button class="btn-contraproposta" (click)="$event.stopPropagation(); oferecerTroca(transacao)">
            Contraproposta
          </button>
          <button class="btn-recusar" (click)="$event.stopPropagation(); abrirDeletar(transacao)">
            Cancelar
          </button>
        </ng-template>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal" *ngIf="mostrarConfirmacao" (click)="cancelarConfirmacao()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>Confirmar Aceite</h3>
    <p>Tem certeza que deseja aceitar esta transação?</p>
    <p class="info-text">Ao aceitar, você confirma a troca dos produtos.</p>
    <div class="modal-actions">
      <button mat-raised-button color="primary" (click)="confirmarAceite()">Confirmar</button>
      <button mat-button (click)="cancelarConfirmacao()">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal de Cancelamento -->
<div class="modal" *ngIf="mostrarDeletar" (click)="cancelarDeletar()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>Confirmar Cancelamento</h3>
    <p>Tem certeza que deseja cancelar esta transação?</p>
    <p class="warning-text">Esta ação não pode ser desfeita.</p>
    <div class="modal-actions">
      <button mat-raised-button color="warn" (click)="confirmarDelete()">Confirmar</button>
      <button mat-button (click)="cancelarDeletar()">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal modal-swipeable" *ngIf="mostrarDetalhes" (click)="fecharDetalhes()" 
     [style.opacity]="modalOpacity"
     [style.transition]="isSwipingModal ? 'none' : 'opacity 0.3s ease'">
  <div class="modal-content modal-detalhes" 
       (click)="$event.stopPropagation()" 
       (touchstart)="onTouchStart($event)"
       (touchmove)="onTouchMove($event)" 
       (touchend)="onTouchEnd($event)"
       [style.transform]="modalTransform"
       [style.transition]="isSwipingModal ? 'none' : 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)'"  
       [style.will-change]="isSwipingModal ? 'transform' : 'auto'">
    <div class="modal-header">
      <h3>Detalhes da Transação</h3>
      <button mat-icon-button (click)="fecharDetalhes()" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="modal-body" *ngIf="transacaoSelecionada">
      <!-- Informações da Transação -->
      <div class="info-section">
        <p><strong>ID:</strong> #{{ transacaoSelecionada.id }}</p>
        <p><strong>Data:</strong> {{ transacaoSelecionada.dataTransacao | date:'dd/MM/yyyy HH:mm' }}</p>
        <p>
          <strong>Status:</strong> 
          <span [ngSwitch]="transacaoSelecionada.status" class="status-badge">
            <span *ngSwitchCase="1" class="status-concluida">Concluída</span>
            <span *ngSwitchCase="2" class="status-pendente">Pendente</span>
            <span *ngSwitchCase="3" class="status-cancelada">Cancelada</span>
            <span *ngSwitchCase="4" class="status-estornada">Estornada</span>
            <span *ngSwitchDefault>Desconhecido</span>
          </span>
        </p>
      </div>

      <!-- Produtos Envolvidos -->
      <div class="produtos-detalhes">
        <div class="lado-detalhes">
          <h4>{{ isUsuarioEnviou(transacaoSelecionada) ? 'Você oferece' : 'Outro usuário oferece' }}:</h4>
          <div class="produtos-lista-detalhes">
            <div *ngFor="let produto of getMeusProdutos(transacaoSelecionada)" 
                 class="produto-detalhe produto-clicavel" 
                 (click)="abrirDetalhesProduto(produto.id, $event)">
              <img [src]="produto.imagem" [alt]="produto.nome" (error)="onImageError($event)">
              <div class="produto-info-detalhe">
                <p class="nome">{{ produto.nome }}</p>
                <p class="descricao" *ngIf="produto.descricao">{{ produto.descricao }}</p>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="lado-detalhes">
          <h4>{{ isUsuarioEnviou(transacaoSelecionada) ? 'Outro usuário oferece' : 'Você oferece' }}:</h4>
          <div class="produtos-lista-detalhes">
            <div *ngFor="let produto of getProdutosOutroUsuario(transacaoSelecionada)" 
                 class="produto-detalhe produto-clicavel" 
                 (click)="abrirDetalhesProduto(produto.id, $event)">
              <img [src]="produto.imagem" [alt]="produto.nome" (error)="onImageError($event)">
              <div class="produto-info-detalhe">
                <p class="nome">{{ produto.nome }}</p>
                <p class="descricao" *ngIf="produto.descricao">{{ produto.descricao }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Botões de Ação -->
      <div class="modal-actions" *ngIf="statusSelecionado === 2">
        <ng-container *ngIf="isUsuarioEnviou(transacaoSelecionada); else botoesModalRecebedor">
          <button mat-raised-button color="warn" (click)="fecharDetalhes(); abrirDeletar(transacaoSelecionada)">
            Cancelar Transação
          </button>
        </ng-container>
        <ng-template #botoesModalRecebedor>
          <button mat-raised-button color="primary" (click)="fecharDetalhes(); abrirConfirmacao(transacaoSelecionada)">
            Aceitar
          </button>
          <button mat-raised-button color="accent" (click)="fecharDetalhes(); oferecerTroca(transacaoSelecionada)">
            Contraproposta
          </button>
          <button mat-raised-button color="warn" (click)="fecharDetalhes(); abrirDeletar(transacaoSelecionada)">
            Cancelar
          </button>
        </ng-template>
      </div>
      
      <!-- Botão de Chat para transações concluídas -->
      <div class="modal-actions" *ngIf="statusSelecionado === 1">
        <button mat-raised-button color="primary" (click)="abrirChat(transacaoSelecionada)">
          <mat-icon>chat</mat-icon>
          Abrir Chat
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Detalhes do Produto -->
<app-detalhes-produto></app-detalhes-produto>
